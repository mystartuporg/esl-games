<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Basketball Game</title>
	<link rel="stylesheet" type = "text/css" href = "../assets/basketball/css/font-loader.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.2/phaser.min.js"></script>
	<style type="text/css">
		body {
			margin: 0;
		}

		canvas {
			margin: 0 auto;
			border: thin solid black;
		}

		span {
			display: block;
			margin: 30px auto;
			width: 500px;
			text-align: center;
		}

		h2 {
			text-align: center;
		}
	</style>
</head>

<body>

	<script type="text/javascript">
		// TODO
		// add a check here if the user has already submitted the info using the form
		// if not yet submitted, redirect to user form
		var game = new Phaser.Game(405, 670, Phaser.CANVAS, '', { preload: preload, create: create, update: update });

		function preload() {
			game.load.image('arcade', '../assets/basketball/images/arcade.png');

			game.load.image('ball', '../assets/basketball/images/ball.png');
			game.load.image('side rim', '../assets/basketball/images/side_rim.png');
			game.load.image('front rim', '../assets/basketball/images/front_rim.png');

			game.load.audio('score', '../assets/basketball/audio/score.wav');
			game.load.audio('backboard', '../assets/basketball/audio/backboard.wav');
			game.load.audio('whoosh', '../assets/basketball/audio/whoosh.wav');
			game.load.audio('spawn', '../assets/basketball/audio/spawn.wav');
			game.load.audio('buzzer', '../assets/basketball/audio/buzzer.wav');
		}

		var hoop,
			left_rim,
			right_rim,
			ball,
			front_rim,
			current_score = 0,
			current_score_text;

		var score_sound,
			backboard,
			whoosh,
			spawn,
			buzzer;

		var collisionGroup;

		var timer, timerText;

		var digital7Loaded;

		var timeText, scoreText;

		function create() {

			game.add.image(0, 0, 'arcade');

			game.physics.startSystem(Phaser.Physics.P2JS);

			game.physics.p2.setImpactEvents(true);

			game.physics.p2.restitution = 0.63;
			game.physics.p2.gravity.y = 0;

			collisionGroup = game.physics.p2.createCollisionGroup();

			score_sound = game.add.audio('score');
			backboard = game.add.audio('backboard');
			backboard.volume = 0.3;
			whoosh = game.add.audio('whoosh');
			spawn = game.add.audio('spawn');
			buzzer = game.add.audio('buzzer');
			buzzer.volume = 0.3;
			buzzer.onStop.add(gameOver, this);

			game.stage.backgroundColor = "#ffffff";

			current_score_text = game.add.text(0, 0, '', { 
				font: 'Digital-7 Mono', fontSize: '50px',
				fill: '#FF3131', boundsAlignH: 'right',
				boundsAlignV: 'center',
			});
			current_score_text.setTextBounds(301, 16, 0, 0);
			current_score_text.visible = false;

			left_rim = game.add.sprite(155, 184, 'side rim'); // 241, 296
			right_rim = game.add.sprite(255, 184, 'side rim'); // 398, 296

			game.physics.p2.enable([left_rim, right_rim], false);

			left_rim.body.setCircle(2.5);
			left_rim.body.static = true;
			left_rim.body.setCollisionGroup(collisionGroup);
			left_rim.body.collides([collisionGroup]);

			right_rim.body.setCircle(2.5);
			right_rim.body.static = true;
			right_rim.body.setCollisionGroup(collisionGroup);
			right_rim.body.collides([collisionGroup]);

			createBall();

			cursors = game.input.keyboard.createCursorKeys();

			game.input.onDown.add(click, this);
			game.input.onUp.add(release, this);

			timer = game.time.create(false);
			timer.start();
			timerText = game.add.text(0, 0, '', { 
				font: 'Digital-7 Mono', fontSize: '50px',
				fill: '#FF3131', boundsAlignH: 'right',
				boundsAlignV: 'center',
			});
			timerText.setTextBounds(151, 16, 0, 0);
			timerText.visible = false;
		}

		function timesUp() {
			buzzer.play();
			if (!ball.launched) {
				ball.kill();
			}
		}

		function update() {

			if (ball && ball.body.velocity.y > 0) {
				front_rim = game.add.sprite(150, 184, 'front rim');
				ball.body.collides([collisionGroup], hitRim, this);
			}

			if (ball && ball.body.velocity.y > 0 && ball.body.y > 188 && !ball.isBelowHoop) {
				ball.isBelowHoop = true;
				ball.body.collideWorldBounds = false;
				var rand = Math.floor(Math.random() * 5);
				if (ball.body.x > 151 && ball.body.x < 249) {
					current_score += 1;
					score_sound.play();
				}
			}

			if (ball && ball.body.y > 1200) {
				game.physics.p2.gravity.y = 0;
				ball.kill();
				if (timer.duration > 0) {
					createBall();
				}
			}

			timerText.text = Math.ceil(timer.duration.toFixed(0) / 1000);
			current_score_text.text = current_score;

			if (!digital7Loaded && document.fonts.check('40px Digital-7 Mono')) {
				timerText.visible = true;
				current_score_text.visible = true;
				digital7Loaded = true;
			}
		}

		function hitRim() {
			backboard.play();
		}

		function createBall() {

			var xpos;
			if (current_score === 0) {
				xpos = 200;
			} else {
				xpos = 60 + Math.random() * 280;
			}
			spawn.play();
			ball = game.add.sprite(xpos, 547, 'ball');
			game.add.tween(ball.scale).from({ x: 0.7, y: 0.7 }, 100, Phaser.Easing.Linear.None, true, 0, 0, false);
			game.physics.p2.enable(ball, false);
			ball.body.setCircle(60); // NOTE: Goes from 60 to 36
			ball.launched = false;
			ball.isBelowHoop = false;

		}

		var location_interval;
		var isDown = false;
		var start_location;
		var end_location;

		function click(pointer) {

			var bodies = game.physics.p2.hitTest(pointer.position, [ball.body]);
			if (bodies.length) {
				start_location = [pointer.x, pointer.y];
				isDown = true;
				location_interval = setInterval(function () {
					start_location = [pointer.x, pointer.y];
				}.bind(this), 200);
			}

		}

		function release(pointer) {

			if (isDown) {
				window.clearInterval(location_interval);
				isDown = false;
				end_location = [pointer.x, pointer.y];

				if (end_location[1] < start_location[1]) {
					var slope = [end_location[0] - start_location[0], end_location[1] - start_location[1]];
					var x_traj = -2300 * slope[0] / slope[1];
					launch(x_traj);
				}
			}

		}

		function launch(x_traj) {

			if (ball.launched === false && !timer.expired) {
				ball.body.setCircle(36);
				ball.body.setCollisionGroup(collisionGroup);
				ball.launched = true;
				game.physics.p2.gravity.y = 3000;
				game.add.tween(ball.scale).to({ x: 0.6, y: 0.6 }, 500, Phaser.Easing.Linear.None, true, 0, 0, false);
				ball.body.velocity.x = x_traj;
				ball.body.velocity.y = -1750;
				ball.body.rotateRight(x_traj / 3);
				whoosh.play();

				if (timer.duration <= 0) {
					timer.add(30000, timesUp, this);
				}
			}

		}

		function gameOver() {
			console.log('Game Over. Final Score is ' + current_score);
			// TODO
			// set localStorage value for the final points
			// redirect to rewards page
		}

	</script>

</body>

</html>